using NUnit.Framework;
using Microsoft.EntityFrameworkCore;
using FinalProject.Models;
using FinalProject.Services;
using System.Reflection;
using Microsoft.Data.Sqlite;


namespace SafeVault.Tests
{
    [TestFixture]
    public class AuthServiceTests
    {
        private AppDbContext _context;
        private AuthService _authService;
        private SqliteConnection _connection;

        [SetUp]
        public void Setup()
        {
            Console.WriteLine("\nTestInputValidation setup starting...");

            var connectionString = "Data Source=:memory"; 
            _authService = new AuthService(connectionString);

            _connection = new SqliteConnection(connectionString);
            _connection.Open();

            var dropTable = _connection.CreateCommand();
            dropTable.CommandText = "DROP TABLE IF EXISTS Users;";
            dropTable.ExecuteNonQuery();

            var createTable = _connection.CreateCommand();
            createTable.CommandText = @"
                CREATE TABLE Users (
                    UserID INTEGER PRIMARY KEY AUTOINCREMENT,
                    Username TEXT NOT NULL,
                    Email TEXT NOT NULL,
                    PasswordHash TEXT NOT NULL,
                    Role TEXT NOT NULL
                );";
            createTable.ExecuteNonQuery();
        }

        [Test]
        public void AuthenticateUser()
        {
            Console.WriteLine("ðŸš¨ Running AuthenticateUser...");

            // Should return true when password matches
            var input = new UserInput
            {
                Username = "testuser",
                Email = "test@example.com",
                Password = "Secret123@"
            };

            _authService.StoreUser(input, role: "User");

            Assert.That(_authService.AuthenticateUser(input.Username, input.Password), Is.True, "User should be authenticated with correct password.");
            Assert.That(_authService.AuthenticateUser(input.Username, "WrongPassword"), Is.False, "Authentication should fail with incorrect password.");

            Console.WriteLine("âœ… AuthenticateUser validation tests passed.");
        }
        
        [TearDown]
        public void Teardown()
        {
            _connection?.Dispose();
            Console.WriteLine("âœ… Test finished.");
        }
    }
}
